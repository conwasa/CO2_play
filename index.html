<DOCTYPE html>
<head>
 <meta charset="utf-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
 <!-- http://t.co/dKP3o1e -->
 <meta name="HandheldFriendly" content="True">
 <meta name="MobileOptimized" content="320">
 <style>
 chart_width = 22;

Body { 	font-family: "Lucida Console", Monaco, monospace;
		font-size:small;
		}
.smaller {font-size:xx-small;}
.page_orientation.smaller {font-size:xx-small;}
.chart {width: 100%;
		background: purple'
		margin-left: 0px}

.medium_size {font-size:small}

@media (min-width: 800px) {
		.smaller {	font-size:small;}
		.chart 	{	width: 70%;
					background: yellow;}
		.medium_size {font-size:small}
		}
@media (max-width: 800px) and screen and (orientation: portrait) {div {background-color: green;}
											.page_orientation span { display: none;}
											.page_orientation:after {content: 'in Portrait display mode';}
											}
@media (min-width: 800px)screen and (orientation: landscape) {div {background-color: orange;}  
											.page_orientation span { display: none;}
											.page_orientation:after {content: 'in Landscape display mode';}
											}

 </style>
 
 <title>UK BN3 CO2 montioring station Real-time Outdoor CO2 ppm</title>
 <meta name="description" content="UK BN3 CO2 montioring station Real-time Outdoor CO2 ppm">
 
 <script src="handlebars-v4.0.11.js"></script>

 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
 <script src="jquery.csv.min.js"></script>
 <script type="text/javascript" src="https://www.google.com/jsapi"></script>
 
<script type="text/javascript"> // load the visualisation API
  google.load('visualization', '1', { packages: ['corechart', 'controls'] });
</script>

<script type="text/javascript">
function drawVisualization() {
	var graph_width2 = 111

//   $.get("todays_readings.csv", function(csvString) {
   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/todays_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_1 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_1',
         dataTable: data,
         options:{
            width: 450, height: 160,
            title: "Today's outdoor CO\u2082 levels [ppm]",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_1.draw();
   });

   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/yesterdays_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_3 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_3',
         dataTable: data,
         options:{
            width: '100%', height: 160,
            title: "yesterday's readings",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_3.draw();
   });

   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/day_befores_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_2 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_2',
         dataTable: data,
         options:{
            width: '100%', height: 160,
            title: "the day before's",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_2.draw();
   });

   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/last_weeks_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_4 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_4',
         dataTable: data,
         options:{
            width: '100%', height: 160,
            title: "last weeks' readings",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_4.draw();
   });

   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/last_months_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_5 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_5',
         dataTable: data,
         options:{
            width: '100%', height: 160,
            title: "last months' readings",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_5.draw();
   });


   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/all_historic_readings.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var chart_6 = new google.visualization.ChartWrapper({
         chartType: 'LineChart',
         containerId: 'chart_6',
         dataTable: data,
         options:{
            width: '100%', height: 160,
            title: "all historic readings",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 11},
         }
      });
      chart_6.draw();
   });

   $.get("https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/outages.csv", function(csvString) {
      // transform the CSV string into a 2-dimensional array
      var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
      // this new DataTable object holds all the data
      var data = new google.visualization.arrayToDataTable(arrayData);
      var table_1 = new google.visualization.ChartWrapper({
         chartType: 'Table',
         containerId: 'table_1',
         dataTable: data,
         options:{
            width: 300, height: 300,
            title: "outages",
			legend: 'left',
            titleTextStyle : {color: 'grey', fontSize: 8},
         }
      });
      table_1.draw();
   });

	var ourRequest = new XMLHttpRequest();
	var URL = 'https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/stats.json';
  ourRequest.open('GET', 'https://bypasscors.herokuapp.com/api/?url=https://storage.googleapis.com/uk_bn3_co2/stats.json');
  ourRequest.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      // Action to be performed when the document is read;
	  console.log('ready state good');
 	  data1 = JSON.parse(ourRequest.responseText); /* made into a global variable for debugging */

	  var myInfo = "{{{line1}}}<br>{{{line2}}}<br>{{{line3}}}<br>";
	  var template = Handlebars.compile(myInfo);

	  var data2 = template(data1)
	  console.log('data=' + data1);

	  document.getElementById("page_start").innerHTML += data2  
	  // createHTML(data1);
    } else {
	   console.log('readyState=' + this.readyState + ' status=' +this.status);
    }
  };
  ourRequest.onerror = function () {
    console.log('connection error');
  }
  ourRequest.send();
console.log('myvar=' + 	11);

}

google.setOnLoadCallback(drawVisualization)

</script>
</head>
<body>
<H1  class="medium_size">Outdoor CO<sub>2</sub> levels Brighton England UK BN3</H1>

<div id="page_start" class="smaller"></div>
<div class="page_orientation smaller"><span></span></div>
<p>
<div id="chart_1" class="chart"></div>

<div id="chart_3" class="chart"></div>

<div id="chart_2" class="chart"></div>

<div id="chart_4" class="chart"></div>

<div id="chart_5" class="chart"></div>

<div id="chart_6" class="chart"></div>
<p>
<div id="table_1"></div>
<p>
<a href="all_readings.csv" download>Download data</a>
<h3>About</h3>
Readings are taken every 10 minutes. 
<p>The data has structure. Why? The sensor is in a street of 1930s semi detached houses with one or two cars per house. At the time of writing there are daily peaks in the morning and early evening. Its not the cars. Its winter and plant growth is stunted. Its cold outside.  

<h3>Development Notes</h3>
The hardware is a Senselife CAM desktop indoor air quality meter, connected to a laptop via a 30ft (10m) USB extension cable. The sensor is at ground level.
A Python program processes the data to produce CSV files for the graphs and table, and Json for statistics. The graphs and table are produced using 
Google's Visualisation API and Json rendered using Handlebars. CSV and Json files are coied to a Google storage bucket. 

<p>Daily readings are padded with a value of 420 to 23:59 so it can be visually compared with the previous day.
<p>
I tried getting the Windows logging software to run on Linux, but didn't get past the logging software freezing after returning the first value.
Its likely a handshaking issue. Its running on Windows 7.
<p>
A CORS problem accessing https://storage.googleapis.com/uk_bn3_co2/ from Github was bypassed using https://bypasscors.herokuapp.com/. 
<p>

<h3>To Do List</h3>
<ul>
<li>Add calls to Twitter API, tweet 'record high/low/etc </li>
<li>Add controls to page back and forth through the graphs</li>
<li>Move to Linux laptop that runs 24x7</li>
<li>Add local outdoor temperature logging</li>
<li>Add a second CO&#8322 sensor  in the same enclosure to gauge accuracy</li>
<li>Add traffic flow on the Old Shoreham Road, probably from Google Maps API</li>
<li>Add mobile location aware version to vechile</li>
</ul>
</body>
  